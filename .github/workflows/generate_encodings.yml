name: Generate Encodings

on:
  workflow_dispatch: {}
  push:
    branches:
      - Insightface

jobs:
  generate-encodings:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libglib2.0-0 libsm6 libxrender1 libxext6 libgl1 ffmpeg build-essential python3-dev

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy==1.24.3 onnxruntime opencv-python-headless supabase insightface python-dotenv pydantic streamlit

      - name: Run Pregenerate Encodings
        env:
          USE_SUPABASE: "true"
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          SUPABASE_BUCKET: ${{ secrets.SUPABASE_BUCKET }}
          PYTHONPATH: ${{ github.workspace }}/streamlit
        working-directory: ./streamlit
        run: |
          # Generates the file into streamlit/data/
          python app.py --generate

      - name: Upload to Supabase Storage (Cloud Path)
        if: success()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          SUPABASE_BUCKET: ${{ secrets.SUPABASE_BUCKET }}
        run: |
          python -c "
          import os
          from supabase import create_client
          
          # 1. Setup Client
          url = os.environ.get('SUPABASE_URL')
          key = os.environ.get('SUPABASE_KEY')
          bucket = os.environ.get('SUPABASE_BUCKET')
          supabase = create_client(url, key)
          
          # 2. Define Paths
          local_file = 'streamlit/data/encodings_insightface.pkl'
          cloud_path = 'raw_faces/encodings/encodings_insightface.pkl'
          
          # 3. Upload with Upsert (Overwrite)
          if os.path.exists(local_file):
              with open(local_file, 'rb') as f:
                  supabase.storage.from_(bucket).upload(
                      path=cloud_path, 
                      file=f, 
                      file_options={'upsert': 'true'}
                  )
              print(f'✅ Successfully uploaded to: {cloud_path}')
          else:
              print(f'❌ Local file {local_file} not found!')
              exit(1)
          "

      - name: Upload Artifact to GitHub (Backup)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: face-encodings
          path: streamlit/data/encodings_insightface.pkl