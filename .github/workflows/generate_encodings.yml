name: Generate Encodings

on:
  workflow_dispatch: {}
  push:
    branches:
      - Insightface

jobs:
  generate-encodings:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Cache InsightFace models
        uses: actions/cache@v4
        with:
          path: ~/.insightface/models/
          key: ${{ runner.os }}-insightface-buffalo-s
          restore-keys: |
            ${{ runner.os }}-insightface-

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libglib2.0-0 libsm6 libxrender1 libxext6 libgl1 ffmpeg build-essential python3-dev

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy==1.24.3 onnxruntime opencv-python-headless supabase insightface python-dotenv pydantic streamlit sqlalchemy

      - name: Run Pregenerate Encodings
        env:
          # Supabase Credentials
          USE_SUPABASE: "true"
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          SUPABASE_BUCKET: ${{ secrets.SUPABASE_BUCKET }}
          
          # Database Credentials (Required by app/database.py)
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          
          # Ensure Python can find both the app/ and streamlit/ directories
          PYTHONPATH: ${{ github.workspace }}:${{ github.workspace }}/streamlit
        working-directory: ./streamlit
        run: |
          # 1. Create directory structure
          mkdir -p data/raw_faces
          
          # 2. Execute the script
          echo "üöÄ Starting Python script..."
          python main.py --generate
          
          # 3. IMMEDIATE VERIFICATION
          if [ -f "data/encodings_insightface.pkl" ]; then
            echo "‚úÖ SUCCESS: Encodings file created locally."
          else
            echo "‚ùå ERROR: Encodings file was not found in $(pwd)/data/"
            ls -R
            exit 1
          fi

      - name: Upload Encodings to Supabase Storage
        if: success()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          SUPABASE_BUCKET: ${{ secrets.SUPABASE_BUCKET }}
        run: |
          # Look for the upload script (likely in your scripts folder or streamlit folder)
          UPLOAD_SCRIPT=$(find . -name "upload_encodings_to_supabase.py" | head -n 1)
          if [ -f "$UPLOAD_SCRIPT" ]; then
            echo "üöÄ Running Upload Script: $UPLOAD_SCRIPT"
            python "$UPLOAD_SCRIPT"
          else
            echo "‚ùå ERROR: Upload script not found in repository."
            exit 1
          fi

      - name: Upload Artifact to GitHub (Safety Backup)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: face-encodings
          path: streamlit/data/encodings_insightface.pkl
          if-no-files-found: warn